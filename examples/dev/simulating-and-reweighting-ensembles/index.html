
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The documentation for cryoJAX.">
      
      
        <meta name="author" content="Michael O'Brien">
      
      
        <link rel="canonical" href="https://michael-0brien.github.io/cryojax/examples/dev/simulating-and-reweighting-ensembles/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Simulating and reweighting ensembles - cryoJAX</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../_static/custom_css.css">
    
      <link rel="stylesheet" href="../../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#simulating-ensembles-and-doing-ensemble-reweighting" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="cryoJAX" class="md-header__button md-logo" aria-label="cryoJAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.79 13.95-2.33.62-2-1.13v-2.88l2-1.13 2.33.62.52-1.93-1.77-.47.46-1.77-1.93-.52-.62 2.33-2 1.13L13 7.38V5.12l1.71-1.71L13.29 2 12 3.29 10.71 2 9.29 3.41 11 5.12v2.26L8.5 8.82l-2-1.13-.58-2.33L4 5.88l.47 1.77-1.77.47.52 1.93 2.33-.62 2 1.13v2.89l-2 1.13-2.33-.62-.52 1.93 1.77.47L4 18.12l1.93.52.62-2.33 2-1.13L11 16.62v2.26l-1.71 1.71L10.71 22 12 20.71 13.29 22l1.41-1.41-1.7-1.71v-2.26l2.5-1.45 2 1.13.62 2.33 1.88-.51-.47-1.77 1.77-.47zM9.5 10.56 12 9.11l2.5 1.45v2.88L12 14.89l-2.5-1.45z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            cryoJAX
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simulating and reweighting ensembles
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/michael-0brien/cryojax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    michael-0brien/cryojax
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="cryoJAX" class="md-nav__button md-logo" aria-label="cryoJAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.79 13.95-2.33.62-2-1.13v-2.88l2-1.13 2.33.62.52-1.93-1.77-.47.46-1.77-1.93-.52-.62 2.33-2 1.13L13 7.38V5.12l1.71-1.71L13.29 2 12 3.29 10.71 2 9.29 3.41 11 5.12v2.26L8.5 8.82l-2-1.13-.58-2.33L4 5.88l.47 1.77-1.77.47.52 1.93 2.33-.62 2 1.13v2.89l-2 1.13-2.33-.62-.52 1.93 1.77.47L4 18.12l1.93.52.62-2.33 2-1.13L11 16.62v2.26l-1.71 1.71L10.71 22 12 20.71 13.29 22l1.41-1.41-1.7-1.71v-2.26l2.5-1.45 2 1.13.62 2.33 1.88-.51-.47-1.77 1.77-.47zM9.5 10.56 12 9.11l2.5 1.45v2.88L12 14.89l-2.5-1.45z"/></svg>

    </a>
    cryoJAX
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/michael-0brien/cryojax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    michael-0brien/cryojax
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to cryoJAX!
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulate-image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Simulate an image
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../jax-transformations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JAX transformations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../compute-potential/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Render a volume
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../read-dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Load cryo-EM images
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extending-cryojax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create custom image simulation methods
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Your first program
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Your first program
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulate-relion-dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write a STAR file of simulated data
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Advanced usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Advanced usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure-refinement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Structural refinement using gradient descent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.simulator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            cryojax.simulator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Api
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_2" >
        
          
          <label class="md-nav__link" for="__nav_3_1_2" id="__nav_3_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Representing volumes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_2">
            <span class="md-nav__icon md-icon"></span>
            Representing volumes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/pose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Representing poses
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/volume/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modeling cryo-EM volumes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3" >
        
          
          <label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Image formation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            Image formation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/integrator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Volume integration methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/transfer_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contrast transfer functions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/scattering_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scattering approximations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Putting it all together
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            Putting it all together
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuring an image
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/image_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rendering an image
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/simulator/noise_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributions: noisy images and likelihoods
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.dataset
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            cryojax.dataset
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/dataset/relion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RELION compatibility
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.io
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            cryojax.io
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/io/mrc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reading and writing MRC files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/io/atom_loading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reading atomic structures
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.ndimage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            cryojax.ndimage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/ndimage/functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utility functions for image and volume arrays
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.ndimage.operators
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            cryojax.ndimage.operators
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/ndimage/operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filters and masks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.ndimage.transforms
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            cryojax.ndimage.transforms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/ndimage/transforms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transforms
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.coordinates
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            cryojax.coordinates
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/coordinates/making_coordinates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating coordinate systems
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/coordinates/transforming_coordinates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transforming coordinate systems
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.rotations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            cryojax.rotations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/rotations/lie_groups/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Representing rotations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/rotations/conversions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Helpers for converting angular parameterizations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.constants
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            cryojax.constants
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/constants/units/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working with physical units
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/constants/scattering_factor_parameters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scattering factor parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/constants/conventions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Converting between common conventions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    cryojax.jax_util
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            cryojax.jax_util
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/jax_util/filter_specs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Helper functions for Equinox filtering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/jax_util/grid_search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grid search interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/jax_util/pytree_transforms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reparameterizing pytrees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/jax_util/useful_functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Useful JAX functions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Jax and Equinox imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">equinox</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">eqx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jaxtyping</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">PRNGKeyArray</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Plotting imports and functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># CryoJAX imports</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cryojax.image.transform</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cryojax.simulator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cxs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.data</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RelionParticleParameterFile</span><span class="p">,</span>
    <span class="n">RelionParticleStackDataset</span><span class="p">,</span>
    <span class="n">simulate_particle_stack</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_atoms_from_pdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.rotations</span><span class="w"> </span><span class="kn">import</span> <span class="n">SO3</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>/Data/Documents/PhD/Research/cryojax_project/.venv/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="simulating-ensembles-and-doing-ensemble-reweighting">Simulating Ensembles and doing Ensemble Reweighting<a class="headerlink" href="#simulating-ensembles-and-doing-ensemble-reweighting" title="Permanent link">¤</a></h1>
<p>In this tutorial we will generate a heterogeneous dataset by defining a distribution on multiple atomic structures. We will then compute a likelihood matrix
$$ P_{nm} = p(y_n | x_m) $$</p>
<p>where <span class="arithmatex">\(y_n\)</span> is a data point and <span class="arithmatex">\(x_m\)</span> is a structure in the ensemble. We will define the likelihood through one of cryoJAX's distributions, although in principle any distribution works.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="generate-a-starfile">Generate a starfile<a class="headerlink" href="#generate-a-starfile" title="Permanent link">¤</a></h1>
<p>First, we will just follow the tutorial <code>simulate-relion-dataset.ipynb</code> to generate a starfile. No ensemble stuff yet.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nd">@partial</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_particle_parameters</span><span class="p">(</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span> <span class="n">instrument_config</span><span class="p">:</span> <span class="n">cxs</span><span class="o">.</span><span class="n">InstrumentConfig</span>
<span class="p">):</span>  <span class="c1"># -&amp;gt; tuple[RelionParticleParameters, RelionParticleParameters]:</span>
    <span class="c1"># Generate random parameters</span>

    <span class="c1"># Pose</span>
    <span class="c1"># ... instantiate rotations</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># split the key to use for the next random number</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">SO3</span><span class="o">.</span><span class="n">sample_uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">)</span>

    <span class="c1"># ... now in-plane translation</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">instrument_config</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># do this everytime you use a key!!</span>
    <span class="n">offset_in_angstroms</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">minval</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
        <span class="o">*</span> <span class="n">instrument_config</span><span class="o">.</span><span class="n">pixel_size</span>
    <span class="p">)</span>
    <span class="c1"># ... build the pose</span>
    <span class="n">pose</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">EulerAnglePose</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="n">offset_in_angstroms</span><span class="p">)</span>

    <span class="c1"># CTF Parameters</span>
    <span class="c1"># ... defocus</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">defocus_in_angstroms</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">astigmatism_in_angstroms</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">astigmatism_angle</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">phase_shift</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># no more random numbers needed</span>

    <span class="c1"># now generate your non-random values</span>
    <span class="n">spherical_aberration_in_mm</span> <span class="o">=</span> <span class="mf">2.7</span>
    <span class="n">amplitude_contrast_ratio</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># ... build the CTF</span>
    <span class="n">transfer_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastTransferTheory</span><span class="p">(</span>
        <span class="n">ctf</span><span class="o">=</span><span class="n">cxs</span><span class="o">.</span><span class="n">CTF</span><span class="p">(</span>
            <span class="n">defocus_in_angstroms</span><span class="o">=</span><span class="n">defocus_in_angstroms</span><span class="p">,</span>
            <span class="n">astigmatism_in_angstroms</span><span class="o">=</span><span class="n">astigmatism_in_angstroms</span><span class="p">,</span>
            <span class="n">astigmatism_angle</span><span class="o">=</span><span class="n">astigmatism_angle</span><span class="p">,</span>
            <span class="n">spherical_aberration_in_mm</span><span class="o">=</span><span class="n">spherical_aberration_in_mm</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">amplitude_contrast_ratio</span><span class="o">=</span><span class="n">amplitude_contrast_ratio</span><span class="p">,</span>
        <span class="n">phase_shift</span><span class="o">=</span><span class="n">phase_shift</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">particle_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;instrument_config&quot;</span><span class="p">:</span> <span class="n">instrument_config</span><span class="p">,</span>
        <span class="s2">&quot;pose&quot;</span><span class="p">:</span> <span class="n">pose</span><span class="p">,</span>
        <span class="s2">&quot;transfer_theory&quot;</span><span class="p">:</span> <span class="n">transfer_theory</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">particle_parameters</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Generate instrument config</span>
<span class="n">instrument_config</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">InstrumentConfig</span><span class="p">(</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
    <span class="n">pixel_size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">voltage_in_kilovolts</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>
    <span class="n">pad_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># no padding</span>
<span class="p">)</span>

<span class="c1"># Generate RNG keys</span>
<span class="n">number_of_images</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">number_of_images</span><span class="p">)</span>

<span class="c1"># ... instantiate the RelionParticleDataset</span>
<span class="n">particle_parameters</span> <span class="o">=</span> <span class="n">make_particle_parameters</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">instrument_config</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># ... generate the starfile</span>
<span class="n">new_parameters_file</span> <span class="o">=</span> <span class="n">RelionParticleParameterFile</span><span class="p">(</span>
    <span class="n">path_to_starfile</span><span class="o">=</span><span class="s2">&quot;./outputs/heterogeneous_relion_dataset.star&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>  <span class="c1"># writing mode!</span>
    <span class="n">exists_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># in case the file already exists</span>
<span class="p">)</span>
<span class="n">new_parameters_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particle_parameters</span><span class="p">)</span>
<span class="n">new_parameters_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="simulating-images-by-choosing-a-random-structure">Simulating images by choosing a random structure<a class="headerlink" href="#simulating-images-by-choosing-a-random-structure" title="Permanent link">¤</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># First load the starfile</span>

<span class="n">path_to_mrc_files</span> <span class="o">=</span> <span class="s2">&quot;./outputs/relion_dataset_particles/heterogeneous&quot;</span>

<span class="n">particle_dataset</span> <span class="o">=</span> <span class="n">RelionParticleStackDataset</span><span class="p">(</span>
    <span class="n">new_parameters_file</span><span class="p">,</span>
    <span class="n">path_to_relion_project</span><span class="o">=</span><span class="n">path_to_mrc_files</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="n">mrcfile_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;overwrite&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>  <span class="c1"># customize your .mrcs !</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_tabulated_scattering_factor_parameters</span>


<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./data/groel_chainA.pdb&quot;</span><span class="p">,</span> <span class="s2">&quot;./data/groel_chainA_holo.pdb&quot;</span><span class="p">]</span>

<span class="n">box_size</span> <span class="o">=</span> <span class="n">new_parameters_file</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">potentials</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">voxel_size</span> <span class="o">=</span> <span class="n">new_parameters_file</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pixel_size</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
    <span class="c1"># Load the atomic structure and transform into a potential</span>
    <span class="n">atom_positions</span><span class="p">,</span> <span class="n">atom_identities</span><span class="p">,</span> <span class="n">bfactors</span> <span class="o">=</span> <span class="n">read_atoms_from_pdb</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;not element H&quot;</span><span class="p">,</span> <span class="n">loads_b_factors</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">scattering_factor_parameters</span> <span class="o">=</span> <span class="n">get_tabulated_scattering_factor_parameters</span><span class="p">(</span>
        <span class="n">atom_identities</span>
    <span class="p">)</span>
    <span class="n">atomic_potential</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">PengAtomicPotential</span><span class="p">(</span>
        <span class="n">atom_positions</span><span class="p">,</span>
        <span class="n">scattering_factor_a</span><span class="o">=</span><span class="n">scattering_factor_parameters</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
        <span class="n">scattering_factor_b</span><span class="o">=</span><span class="n">scattering_factor_parameters</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
        <span class="n">b_factors</span><span class="o">=</span><span class="n">bfactors</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Convert to a real voxel grid</span>
    <span class="c1"># This step is optional, you could use the atomic potential directly!</span>
    <span class="n">real_voxel_grid</span> <span class="o">=</span> <span class="n">atomic_potential</span><span class="o">.</span><span class="n">as_real_voxel_grid</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">box_size</span><span class="p">),</span> <span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span>
    <span class="p">)</span>
    <span class="n">potential</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">FourierVoxelGridPotential</span><span class="o">.</span><span class="n">from_real_voxel_grid</span><span class="p">(</span>
        <span class="n">real_voxel_grid</span><span class="p">,</span> <span class="n">voxel_size</span><span class="p">,</span> <span class="n">pad_scale</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">potential</span><span class="p">)</span>

<span class="n">potentials</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">potentials</span><span class="p">)</span>
<span class="n">potential_integrator</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">FourierSliceExtraction</span><span class="p">()</span>

<span class="c1"># Use this if using an atomic potential</span>
<span class="c1"># potential_integrator = cxs.GaussianMixtureProjection()</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="admonition info">
<p class="admonition-title">Info</p>
</div>
<p>See our tutorial on simulating simple datasets for more details for how to generate an dataset with noisy images</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.inference.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IndependentGaussianPixels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_image</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">constant_args</span><span class="p">,</span> <span class="n">per_particle_args</span><span class="p">):</span>
    <span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">constant_args</span>
    <span class="n">noise_key</span><span class="p">,</span> <span class="n">potential_id</span> <span class="o">=</span> <span class="n">per_particle_args</span>  <span class="c1"># jax random stuff</span>

    <span class="n">structural_ensemble</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteStructuralEnsemble</span><span class="p">(</span>
        <span class="n">potentials</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;pose&quot;</span><span class="p">],</span>
        <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteConformationalVariable</span><span class="p">(</span><span class="n">potential_id</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">scattering_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">WeakPhaseScatteringTheory</span><span class="p">(</span>
        <span class="n">structural_ensemble</span><span class="p">,</span> <span class="n">potential_integrator</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;transfer_theory&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">image_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastImageModel</span><span class="p">(</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">],</span> <span class="n">scattering_theory</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
    <span class="p">)</span>

    <span class="n">distribution</span> <span class="o">=</span> <span class="n">IndependentGaussianPixels</span><span class="p">(</span>
        <span class="n">image_model</span><span class="p">,</span>
        <span class="n">variance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">signal_scale_factor</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span>
        <span class="n">normalizes_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">distribution</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">noise_key</span><span class="p">,</span> <span class="n">applies_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="simulating-the-images">Simulating the images<a class="headerlink" href="#simulating-the-images" title="Permanent link">¤</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">snr</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># define whatever snr you want</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">CircularCosineMask</span><span class="p">(</span>
    <span class="n">coordinate_grid</span><span class="o">=</span><span class="n">instrument_config</span><span class="o">.</span><span class="n">coordinate_grid_in_pixels</span><span class="p">,</span>
    <span class="n">radius</span><span class="o">=</span><span class="n">instrument_config</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">rolloff_width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">constant_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">snr</span><span class="p">)</span>

<span class="c1"># Generate RNG keys for per-image noise, and per-image conformations</span>
<span class="n">keys_noise</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">number_of_images</span><span class="p">)</span>
<span class="n">key_structure</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Generate the per-image conformation assignments</span>
<span class="n">ensemble_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>  <span class="c1"># weights for sampling structures</span>
<span class="n">potential_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Exactly 30 will come from potential with id 0</span>
<span class="n">potential_ids</span> <span class="o">=</span> <span class="n">potential_ids</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ensemble_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_images</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">simulate_particle_stack</span><span class="p">(</span>
    <span class="n">particle_dataset</span><span class="p">,</span>
    <span class="n">compute_image_fn</span><span class="o">=</span><span class="n">compute_image</span><span class="p">,</span>
    <span class="n">constant_args</span><span class="o">=</span><span class="n">constant_args</span><span class="p">,</span>
    <span class="n">per_particle_args</span><span class="o">=</span><span class="p">(</span><span class="n">keys_noise</span><span class="p">,</span> <span class="n">potential_ids</span><span class="p">),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">images_per_file</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="computing-a-likelihood-matrix">Computing a likelihood Matrix<a class="headerlink" href="#computing-a-likelihood-matrix" title="Permanent link">¤</a></h1>
<p>Now we have a heterogeneous dataset. Let's say we have a new ensemble (I'll use the true one for simplicity), we want to generate the likelihood between each member of the ensemble and each image. This will give us a likelihood matrix, which can be used for ensemble reweighting among other things.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="setting-up-a-dataloader">Setting up a dataloader<a class="headerlink" href="#setting-up-a-dataloader" title="Permanent link">¤</a></h2>
<p>Normally, you'll have thousands of images, so loading them all into memory at once is not a good idea. CryoJAX is very flexible, and allows us to use external dataloaders. Here I will use the dataloader implemented in: https://github.com/BirkhoffG/jax-dataloader</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># !pip install jax_dataloader (run this!)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">jax_dataloader</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jdl</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomJaxDataset</span><span class="p">(</span><span class="n">jdl</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cryojax_dataset</span><span class="p">:</span> <span class="n">RelionParticleStackDataset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cryojax_dataset</span> <span class="o">=</span> <span class="n">cryojax_dataset</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cryojax_dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cryojax_dataset</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">dataloader</span> <span class="o">=</span> <span class="n">jdl</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">CustomJaxDataset</span><span class="p">(</span>
        <span class="n">particle_dataset</span>
    <span class="p">),</span>  <span class="c1"># Can be a jdl.Dataset or pytorch or huggingface or tensorflow dataset</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;jax&quot;</span><span class="p">,</span>  <span class="c1"># Use &#39;jax&#39; backend for loading data</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>  <span class="c1"># Batch size</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Shuffle the dataloader every iteration or not</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Drop the last batch or not</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="computing-the-likelihood">Computing the likelihood<a class="headerlink" href="#computing-the-likelihood" title="Permanent link">¤</a></h1>
<p>Here we show several ways to compute the likelihood. I will show how to compute it using vmapping, but also jax.lax.map, which is usually more memory friendly. I will also show how to compute the likelihood from a stack of atom_positions, which will be useful for computing gradients for atomic structures.</p>
<p>In all cases we will vmap first over images and then over structures/potentials. This is because computing quantities this way is faster. Think about it this way, it is much more easier to grab one potential and compute all the images required, than to compute a potential for every image.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">if_array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood</span><span class="p">(</span>
    <span class="n">potential_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">particle_stack</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">],</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">:</span>
    <span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">structural_ensemble</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteStructuralEnsemble</span><span class="p">(</span>
        <span class="n">potentials</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;pose&quot;</span><span class="p">],</span>
        <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteConformationalVariable</span><span class="p">(</span><span class="n">potential_id</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">scattering_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">WeakPhaseScatteringTheory</span><span class="p">(</span>
        <span class="n">structural_ensemble</span><span class="p">,</span>
        <span class="n">potential_integrator</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;transfer_theory&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">image_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastImageModel</span><span class="p">(</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">],</span> <span class="n">scattering_theory</span>
    <span class="p">)</span>

    <span class="n">simulated_image</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">observed_image</span> <span class="o">=</span> <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span>

    <span class="c1"># This is to estimate the snr</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span> <span class="o">*</span> <span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">co</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc</span> <span class="o">-</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">c</span>

    <span class="c1"># remember the noise variance is 1!!</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">observed_image</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">simulated_image</span> <span class="o">-</span> <span class="n">bias</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="computing-with-equinoxfilter_vmap">Computing with equinox.filter_vmap<a class="headerlink" href="#computing-with-equinoxfilter_vmap" title="Permanent link">¤</a></h2>
<p>This is the simplest way to compute the likelihood matrix. Simply set a batch_size in the dataloader such that you don't get memory errors.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_batch</span><span class="p">(</span>
    <span class="n">potential_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">relion_particle_stack</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">],</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">compute_likelihood</span><span class="p">(</span><span class="n">potential_id</span><span class="p">,</span> <span class="n">relion_particle_stack</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_matrix</span><span class="p">(</span>
    <span class="n">dataloader</span><span class="p">:</span> <span class="n">jdl</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">,</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_images n_potentials&quot;</span><span class="p">]:</span>
    <span class="n">n_potentials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">batch_likelihood</span> <span class="o">=</span> <span class="n">compute_likelihood_batch</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_potentials</span><span class="p">),</span> <span class="n">batch</span><span class="p">,</span> <span class="n">args</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">likelihood_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_likelihood</span><span class="p">)</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">likelihood_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">likelihood_matrix</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="n">compute_likelihood_matrix</span><span class="p">(</span>
    <span class="n">dataloader</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># Let&#39;s compute the populations by checking which structure</span>
<span class="c1"># obtains the highest likelihood for each image</span>
<span class="c1"># They should be around 0.3 and 0.7 (this will not be true at low SNR)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population for id 0: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">likelihood_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population for id 1: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">likelihood_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Population for id 0: 30
Population for id 1: 70
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="computing-with-jaxlaxmap">Computing with jax.lax.map<a class="headerlink" href="#computing-with-jaxlaxmap" title="Permanent link">¤</a></h2>
<p>Here we need to use equinox partition, as jax.lax.map does not have utilities such as eqx.if_array (see how we vmapped in the previous example). The filtering is very simple, we just need to get rid of all leaves that are not arrays.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_single_likelihood</span><span class="p">(</span>
    <span class="n">potential_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">particle_stack</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">],</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">:</span>
    <span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">structural_ensemble</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteStructuralEnsemble</span><span class="p">(</span>
        <span class="n">potentials</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;pose&quot;</span><span class="p">],</span>
        <span class="n">cxs</span><span class="o">.</span><span class="n">DiscreteConformationalVariable</span><span class="p">(</span><span class="n">potential_id</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">scattering_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">WeakPhaseScatteringTheory</span><span class="p">(</span>
        <span class="n">structural_ensemble</span><span class="p">,</span>
        <span class="n">potential_integrator</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;transfer_theory&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">image_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastImageModel</span><span class="p">(</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">],</span> <span class="n">scattering_theory</span>
    <span class="p">)</span>

    <span class="n">simulated_image</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">observed_image</span> <span class="o">=</span> <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span>

    <span class="c1"># This is to estimate the snr</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span> <span class="o">*</span> <span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">co</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc</span> <span class="o">-</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">c</span>

    <span class="c1"># remember the noise variance is 1!!</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">observed_image</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">simulated_image</span> <span class="o">-</span> <span class="n">bias</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>


<span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_with_map</span><span class="p">(</span>
    <span class="n">potential_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">particle_stack</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">],</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span>
    <span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">batch_size_images</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_structures&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes one row of the likelihood matrix (all structures, one image)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stack_map</span><span class="p">,</span> <span class="n">stack_nomap</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">particle_stack</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">is_array</span><span class="p">)</span>

    <span class="n">likelihood_batch</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">compute_single_likelihood</span><span class="p">(</span>
            <span class="n">potential_id</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stack_nomap</span><span class="p">),</span> <span class="n">args</span>
        <span class="p">),</span>
        <span class="n">xs</span><span class="o">=</span><span class="n">stack_map</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size_images</span><span class="p">,</span>  <span class="c1"># compute for this many images in parallel</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">likelihood_batch</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_matrix_with_lax_map</span><span class="p">(</span>
    <span class="n">dataloader</span><span class="p">:</span> <span class="n">jdl</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialRepresentation</span><span class="p">],</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractPotentialIntegrator</span>
    <span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">batch_size_potentials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_images n_structures&quot;</span><span class="p">]:</span>
    <span class="n">n_potentials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">batch_likelihood</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">compute_likelihood_with_map</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">batch_size_images</span><span class="o">=</span><span class="n">batch_size_images</span>
            <span class="p">),</span>
            <span class="n">xs</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_potentials</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size_potentials</span><span class="p">,</span>  <span class="c1"># potentials to compute in parallel</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">likelihood_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_likelihood</span><span class="p">)</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">likelihood_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">likelihood_matrix</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This will take longer, but uses less memory. Play around with the batch sizes. <code>batch_size_potentials</code> controls how many potentials are used in a single vmap operation. <code>batch_size_images</code> controls how many images are used in a single vmap operation. Atomic potentials are cheap when it comes to memory, but they are slower when comparing against many images. Voxel potentials are more memory expensive, but it's vary fast to compare them against many images. This might not be true if you need to compute gradients. Always profile your code!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">likelihood_matrix_lax_map</span> <span class="o">=</span> <span class="n">compute_likelihood_matrix_with_lax_map</span><span class="p">(</span>
    <span class="n">dataloader</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">potentials</span><span class="p">,</span> <span class="n">potential_integrator</span><span class="p">),</span>
    <span class="n">batch_size_potentials</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">batch_size_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="c1"># We get the same result as before</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">likelihood_matrix_lax_map</span><span class="p">,</span> <span class="n">likelihood_matrix</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>Array(True, dtype=bool)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="computing-likelihood-matrix-from-multiple-atomic-positions">Computing likelihood matrix from multiple atomic positions<a class="headerlink" href="#computing-likelihood-matrix-from-multiple-atomic-positions" title="Permanent link">¤</a></h2>
<p>Here we will not convert the atomic potential to a voxel potential, as the objective of this tutorial is to be able to create a loss function that allows for the computation of gradients for the atomic positions</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">if_array</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_atomic</span><span class="p">(</span>
    <span class="n">potential</span><span class="p">:</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractAtomicPotential</span><span class="p">,</span> <span class="n">particle_stack</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">:</span>
    <span class="n">structural_ensemble</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">SingleStructureEnsemble</span><span class="p">(</span>
        <span class="n">potential</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;pose&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">potential_integrator</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">GaussianMixtureProjection</span><span class="p">()</span>

    <span class="n">scattering_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">WeakPhaseScatteringTheory</span><span class="p">(</span>
        <span class="n">structural_ensemble</span><span class="p">,</span>
        <span class="n">potential_integrator</span><span class="p">,</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;transfer_theory&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">image_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastImageModel</span><span class="p">(</span>
        <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;instrument_config&quot;</span><span class="p">],</span> <span class="n">scattering_theory</span>
    <span class="p">)</span>

    <span class="n">simulated_image</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">observed_image</span> <span class="o">=</span> <span class="n">particle_stack</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span>

    <span class="c1"># This is to estimate the snr</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span> <span class="o">*</span> <span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">simulated_image</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_image</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">co</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cc</span> <span class="o">-</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">c</span>

    <span class="c1"># remember the noise variance is 1!!</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">observed_image</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">simulated_image</span> <span class="o">-</span> <span class="n">bias</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>


<span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_build_potential</span><span class="p">(</span>
    <span class="n">atom_positions</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_atoms 3&quot;</span><span class="p">],</span>
    <span class="n">particle_stack</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_atoms&quot;</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_atoms n_gaussians&quot;</span><span class="p">]],</span>
    <span class="p">],</span>
<span class="p">):</span>
    <span class="n">b_factors</span><span class="p">,</span> <span class="n">parameter_table</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">atom_potential</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">PengAtomicPotential</span><span class="p">(</span>
        <span class="n">atom_positions</span><span class="p">,</span>
        <span class="n">scattering_factor_a</span><span class="o">=</span><span class="n">parameter_table</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
        <span class="n">scattering_factor_b</span><span class="o">=</span><span class="n">parameter_table</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span>
        <span class="n">b_factors</span><span class="o">=</span><span class="n">b_factors</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">compute_likelihood_atomic</span><span class="p">(</span><span class="n">atom_potential</span><span class="p">,</span> <span class="n">particle_stack</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_likelihood_matrix_from_atoms</span><span class="p">(</span>
    <span class="n">batch_atom_positions</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_structures n_atoms 3&quot;</span><span class="p">],</span>
    <span class="n">dataloader</span><span class="p">:</span> <span class="n">jdl</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_atoms&quot;</span><span class="p">],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_atoms n_gaussians&quot;</span><span class="p">]],</span>
    <span class="p">],</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; n_images n_structures&quot;</span><span class="p">]:</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">batch_likelihood</span> <span class="o">=</span> <span class="n">compute_likelihood_build_potential</span><span class="p">(</span>
            <span class="n">batch_atom_positions</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">args</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># we want something with shape (n_images, n_atom_positions)</span>

        <span class="n">likelihood_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_likelihood</span><span class="p">)</span>
    <span class="n">likelihood_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">likelihood_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">likelihood_matrix</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="warning">WARNING<a class="headerlink" href="#warning" title="Permanent link">¤</a></h3>
<p>Here I am assuming that all atomic structures have the same set of atoms. Generalizing is not difficult, you just need to be careful about how you handle the atom_identities and the b_factors.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./data/groel_chainA.pdb&quot;</span><span class="p">,</span> <span class="s2">&quot;./data/groel_chainA_holo.pdb&quot;</span><span class="p">]</span>

<span class="n">box_size</span> <span class="o">=</span> <span class="n">instrument_config</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">voxel_size</span> <span class="o">=</span> <span class="n">instrument_config</span><span class="o">.</span><span class="n">pixel_size</span>

<span class="n">single_atom_positions</span><span class="p">,</span> <span class="n">atom_identities</span><span class="p">,</span> <span class="n">b_factors</span> <span class="o">=</span> <span class="n">read_atoms_from_pdb</span><span class="p">(</span>
    <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;not element H&quot;</span><span class="p">,</span> <span class="n">loads_b_factors</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># This is needed to define the Peng Atomic Potential</span>
<span class="n">parameter_table</span> <span class="o">=</span> <span class="n">get_tabulated_scattering_factor_parameters</span><span class="p">(</span><span class="n">atom_identities</span><span class="p">)</span>

<span class="n">batch_atom_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="o">*</span><span class="n">single_atom_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">batch_atom_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_atom_positions</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="c1"># Load the atomic structure and transform into a potential</span>
    <span class="n">batch_atom_positions</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_atoms_from_pdb</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;not element H&quot;</span><span class="p">,</span> <span class="n">loads_b_factors</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># we are only interested in the positions, the resto does not change</span>

<span class="n">batch_atom_positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_atom_positions</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_factors</span><span class="p">,</span> <span class="n">parameter_table</span><span class="p">)</span>

<span class="n">likelihood_matrix_atoms</span> <span class="o">=</span> <span class="n">compute_likelihood_matrix_from_atoms</span><span class="p">(</span>
    <span class="n">batch_atom_positions</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population for id 0: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">likelihood_matrix_atoms</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population for id 1: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">likelihood_matrix_atoms</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Population for id 0: 30
Population for id 1: 70
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>
</code></pre></div>

</div>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>